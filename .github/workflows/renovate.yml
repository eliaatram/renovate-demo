name: Renovate Bot

on:
  schedule:
   - cron: "0 3 * * 1"

  # Allow triggering manually the Github UI
  workflow_dispatch:
    inputs:
      log_level:
        description: "Renovate log level"
        required: false
        default: "info"
        type: choice
        options:
          - debug
          - info
          - warn
      ignore_schedule:
        description: "Ignore schedule (open PRs immediatly)"
        required: false
        default: "true"
        type: choice
        options:
          - "true"
          - "false"

jobs:
  renovate:
    name: Run Renovate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Renovate
        uses: renovatebot/github-action@v46.1.2
        with:
          configurationFile: renovate.json
          token: ${{ secrets.RENOVATE_TOKEN }}
          # Allow RENOVATE_* and LOG_LEVEL env vars to pass through to the container
          # Without this regex, only the token is forwarded
          env-regex: "^(RENOVATE_|LOG_LEVEL)"
        env:
          LOG_LEVEL: ${{ github.event.inputs.log_level || 'info' }}
          RENOVATE_REPOSITORIES: ${{ github.repository }}
          # When triggered manually with ignore_schedule=true, null out the schedule
          # so PRs open immediatly. On cron runs this is {} (no-op)
          RENOVATE_FORCE: ${{ github.event.inputs.ignore_schedule == 'true' && '{"schedule":null}' || '{}'}}
